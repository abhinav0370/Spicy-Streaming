<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch - Spicy</title>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cpath fill='%2300A86B' d='M16 2C12.1 2 9 5.1 9 9c0 1.4.4 2.7 1 3.8C8.7 13.8 7 15.8 7 18c0 3.9 3.1 7 7 7h4c3.9 0 7-3.1 7-7 0-2.2-1.7-4.2-3-5.2.6-1.1 1-2.4 1-3.8 0-3.9-3.1-7-7-7z'/%3E%3Cpath fill='%23008000' d='M16 4c2.8 0 5 2.2 5 5 0 1-.3 2-.8 2.8-.2.3-.4.6-.6.9-.5-.1-1-.2-1.6-.2-2.8 0-5 2.2-5 5 0 .6.1 1.1.3 1.6-.3-.2-.6-.4-.9-.6C12.3 17 12 16 12 15c0-2.8 2.2-5 5-5 .6 0 1.1.1 1.6.3-.2-.3-.4-.6-.6-.9C18.3 8.3 18 7 18 6c0-2.8 2.2-5 5-5z'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cpath fill='%2300A86B' d='M16 2C12.1 2 9 5.1 9 9c0 1.4.4 2.7 1 3.8C8.7 13.8 7 15.8 7 18c0 3.9 3.1 7 7 7h4c3.9 0 7-3.1 7-7 0-2.2-1.7-4.2-3-5.2.6-1.1 1-2.4 1-3.8 0-3.9-3.1-7-7-7z'/%3E%3Cpath fill='%23008000' d='M16 4c2.8 0 5 2.2 5 5 0 1-.3 2-.8 2.8-.2.3-.4.6-.6.9-.5-.1-1-.2-1.6-.2-2.8 0-5 2.2-5 5 0 .6.1 1.1.3 1.6-.3-.2-.6-.4-.9-.6C12.3 17 12 16 12 15c0-2.8 2.2-5 5-5 .6 0 1.1.1 1.6.3-.2-.3-.4-.6-.6-.9C18.3 8.3 18 7 18 6c0-2.8 2.2-5 5-5z'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.10.3/cdn.min.js" defer></script>
    <script src="sources.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    backgroundColor: {
                        'amoled': '#000000',
                        'amoled-light': '#0A0A0A',
                        'amoled-card': '#121212',
                    },
                    borderColor: {
                        'amoled-border': '#1A1A1A',
                    },
                },
            },
        }
    </script>
    <style>
        .player-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
        }

        .player-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        .source-button {
            transition: all 0.3s ease;
        }

        .source-button:hover {
            transform: translateY(-2px);
        }

        .source-button.active {
            background-color: #3b82f6;
            color: white;
        }

        .episode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.75rem;
        }

        @media (min-width: 640px) {
            .episode-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                gap: 1rem;
            }
        }

        @media (min-width: 768px) {
            .episode-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }

        .episode-card {
            transition: all 0.3s ease;
        }

        .episode-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .episode-card.active {
            border: 2px solid #3b82f6;
        }

        .trailer-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 0.5rem;
        }

        .trailer-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
            border-radius: 0.5rem;
        }

        /* Progressive loading animations */
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
            opacity: 0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-delay-1 {
            animation-delay: 0.1s;
        }

        .fade-in-delay-2 {
            animation-delay: 0.2s;
        }

        .fade-in-delay-3 {
            animation-delay: 0.3s;
        }
    </style>
</head>

<body class="bg-amoled min-h-screen text-white" x-data="watchApp()">

    <!-- Home Button - Top Left Corner -->
    <div class="fixed top-4 left-2 sm:top-6 sm:left-4 z-50">
        <a href="index.html"
            class="inline-flex items-center px-2 py-1 sm:px-3 sm:py-2 bg-black text-white border border-gray-600 rounded-lg hover:bg-gray-900 hover:border-gray-500 transition-all duration-200 shadow-lg text-sm sm:text-base">
            <svg class="w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                </path>
            </svg>
            <span class="hidden xs:inline">Home</span>
        </a>
    </div>

    <div class="container mx-auto px-2 sm:px-4 py-16 sm:py-8">
        <div class="w-full max-w-6xl mx-auto">
            <!-- Main Content -->
            <div class="w-full space-y-4 sm:space-y-6">
                <!-- Video Player -->
                <div class="bg-amoled-card rounded-lg shadow-lg overflow-hidden border border-amoled-border fade-in">
                    <div class="player-container">
                        <iframe x-bind:src="currentVideoUrl" allowfullscreen></iframe>
                    </div>
                </div>

                <!-- Content Details -->
                <div x-show="content"
                    class="rounded-lg shadow-lg p-4 sm:p-6 border border-amoled-border fade-in fade-in-delay-1">
                    <div class="flex flex-col lg:flex-row gap-4 sm:gap-6">
                        <!-- Poster -->
                        <div class="flex-shrink-0">
                            <img :src="content.poster_path ? 'https://image.tmdb.org/t/p/w300' + content.poster_path : 'https://via.placeholder.com/300x450?text=No+Image'"
                                :alt="content.title || content.name" class="w-32 sm:w-40 lg:w-48 rounded-lg shadow-lg"
                                @error="event => { event.target.src = 'https://via.placeholder.com/300x450?text=No+Image'; }">
                        </div>

                        <!-- Details -->
                        <div class="flex-1 min-w-0">
                            <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-white mb-2"
                                x-text="content.title || content.name"></h1>

                            <div class="flex flex-wrap items-center gap-2 sm:gap-4 mb-3 text-sm text-gray-300">
                                <span x-show="content.release_date || content.first_air_date" class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                    <span
                                        x-text="new Date(content.release_date || content.first_air_date).getFullYear()"></span>
                                </span>

                                <span x-show="content.vote_average" class="flex items-center">
                                    <svg class="w-4 h-4 mr-1 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                                        <path
                                            d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z">
                                        </path>
                                    </svg>
                                    <span x-text="content.vote_average.toFixed(1) + '/10'"></span>
                                </span>

                                <span x-show="content.runtime" class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span x-text="content.runtime + ' min'"></span>
                                </span>

                                <span x-show="isShow && content.number_of_seasons" class="flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                        </path>
                                    </svg>
                                    <span
                                        x-text="content.number_of_seasons + ' Season' + (content.number_of_seasons > 1 ? 's' : '')"></span>
                                </span>
                            </div>

                            <div x-show="content.genres && content.genres.length > 0" class="flex flex-wrap gap-2 mb-4">
                                <template x-for="genre in content.genres" :key="genre.id">
                                    <span
                                        class="px-2 py-1 bg-blue-600/20 text-blue-300 rounded-full text-xs font-medium"
                                        x-text="genre.name"></span>
                                </template>
                            </div>

                            <p x-show="content.overview" class="text-gray-300 text-sm sm:text-base leading-relaxed mb-4"
                                x-text="content.overview"></p>
                        </div>
                    </div>
                </div>

                <!-- Episode Selector (for TV shows) -->
                <div x-show="isShow"
                    class="rounded-lg shadow-lg p-3 sm:p-6 border border-amoled-border fade-in fade-in-delay-2">
                    <h2 class="text-lg sm:text-xl font-bold mb-3 sm:mb-4 text-white">Episodes</h2>

                    <!-- Season Selector -->
                    <div class="mb-3 sm:mb-4">
                        <label class="block text-xs sm:text-sm font-medium text-gray-300 mb-2">Season</label>
                        <select x-model="selectedSeason" @change="loadEpisodes()"
                            class="w-full px-2 py-2 sm:px-3 sm:py-2 border border-amoled-border rounded-md bg-amoled-light text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                            <template x-for="season in seasons" :key="season">
                                <option :value="season" x-text="'Season ' + season"></option>
                            </template>
                        </select>
                    </div>

                    <!-- Episodes Grid -->
                    <div class="episode-grid" x-show="episodes.length > 0">
                        <template x-for="episode in episodes" :key="episode.episode_number">
                            <div class="episode-card bg-amoled-light rounded-lg p-2 sm:p-4 cursor-pointer border border-amoled-border hover:bg-amoled-card transition-colors"
                                :class="selectedEpisode === episode.episode_number ? 'active border-blue-500 bg-amoled-card' : ''"
                                @click="selectEpisode(episode.episode_number)">
                                <div
                                    class="aspect-video mb-2 sm:mb-3 bg-gray-600 rounded flex items-center justify-center">
                                    <img :src="episode.still_path ? 'https://image.tmdb.org/t/p/w300' + episode.still_path : 'https://via.placeholder.com/300x169?text=Episode+' + episode.episode_number"
                                        :alt="'Episode ' + episode.episode_number"
                                        class="w-full h-full object-cover rounded"
                                        @error="event => { event.target.src = 'https://via.placeholder.com/300x169?text=Episode+' + episode.episode_number; }">
                                </div>
                                <h3 class="font-medium text-xs sm:text-sm mb-1 text-white"
                                    x-text="'Episode ' + episode.episode_number + ': ' + episode.name"></h3>
                                <p class="text-xs text-gray-400 line-clamp-2"
                                    x-text="episode.overview || 'No description available.'"></p>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Trailer -->
                <div x-show="trailerUrl"
                    class="rounded-lg shadow-lg p-4 sm:p-6 border border-amoled-border fade-in fade-in-delay-3">
                    <h2 class="text-lg sm:text-xl font-bold text-white mb-4">Trailer</h2>
                    <div class="trailer-container">
                        <iframe :src="trailerUrl" allowfullscreen></iframe>
                    </div>
                </div>

                <!-- Source Selector -->
                <div class="rounded-lg shadow-lg p-3 sm:p-4 border border-amoled-border fade-in fade-in-delay-3">
                    <div class="flex items-center justify-between mb-3 sm:mb-4">
                        <h2 class="text-lg sm:text-xl font-bold text-white">Streaming Sources</h2>
                        <button @click="showSources = !showSources"
                            class="text-gray-300 hover:text-white p-1 rounded focus:outline-none"
                            :aria-expanded="showSources">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                    </div>

                    <div x-show="showSources" x-transition
                        class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 sm:gap-3">
                        <template x-for="source in availableSources" :key="source.id">
                            <button
                                class="source-button px-2 py-2 sm:px-4 sm:py-2 rounded-md border border-amoled-border hover:border-blue-500 bg-amoled-light text-gray-300 hover:text-white transition-all text-xs sm:text-sm"
                                :class="selectedSource === source.id ? 'active bg-blue-600 border-blue-500 text-white' : ''"
                                @click="changeSource(source.id)" x-text="source.name">
                            </button>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function watchApp() {
            return {
                content: null,
                contentId: null,
                contentType: null,
                isShow: false,
                selectedSeason: 1,
                selectedEpisode: 1,
                seasons: [],
                episodes: [],
                selectedSource: 'multiembed',
                showSources: false,
                availableSources: availableSources,
                currentVideoUrl: '',
                // Additional content data
                trailerUrl: '',
                // Playback tracking
                playbackStarted: false,
                playbackTimer: null,
                minWatchTime: 30000, // 30 seconds
                hasConfirmedPlayback: false,

                init() {
                    const urlParams = new URLSearchParams(window.location.search);
                    this.contentId = urlParams.get('id');
                    this.contentType = urlParams.get('type');
                    const defaultSource = urlParams.get('defaultSource');

                    if (this.contentId && this.contentType) {
                        this.isShow = this.contentType === 'tv';
                        // Use default source if provided, otherwise use multiembed
                        this.selectedSource = defaultSource || 'multiembed';
                        this.loadContent();

                        // Setup playback tracking after content loads
                        setTimeout(() => {
                            this.setupPlaybackTracking();
                        }, 2000);

                        // Cleanup on page unload
                        window.addEventListener('beforeunload', () => {
                            this.stopPlaybackTracking();
                        });
                    }
                }, async loadContent() {
                    try {
                        const response = await fetch(`https://api.themoviedb.org/3/${this.contentType}/${this.contentId}?api_key=1070730380f5fee0d87cf0382670b255`);
                        const data = await response.json();
                        this.content = data;

                        // Load additional data
                        await this.loadTrailer();

                        if (this.isShow) {
                            this.seasons = Array.from({ length: data.number_of_seasons }, (_, i) => i + 1);
                            this.loadEpisodes();
                        } else {
                            this.updateVideoUrl();
                        }
                    } catch (error) {
                        console.error('Error loading content:', error);
                    }
                },

                async loadEpisodes() {
                    try {
                        const response = await fetch(`https://api.themoviedb.org/3/tv/${this.contentId}/season/${this.selectedSeason}?api_key=1070730380f5fee0d87cf0382670b255`);
                        const data = await response.json();
                        this.episodes = data.episodes || [];
                        this.selectedEpisode = 1;
                        this.updateVideoUrl();
                    } catch (error) {
                        console.error('Error loading episodes:', error);
                    }
                },

                async loadTrailer() {
                    try {
                        const response = await fetch(`https://api.themoviedb.org/3/${this.contentType}/${this.contentId}/videos?api_key=1070730380f5fee0d87cf0382670b255`);
                        const data = await response.json();

                        const trailer = data.results?.find(video =>
                            video.type === 'Trailer' &&
                            video.site === 'YouTube' &&
                            video.official === true
                        ) || data.results?.find(video =>
                            video.type === 'Trailer' && video.site === 'YouTube'
                        );

                        if (trailer) {
                            this.trailerUrl = `https://www.youtube.com/embed/${trailer.key}`;
                        }
                    } catch (error) {
                        console.error('Error loading trailer:', error);
                        this.trailerUrl = '';
                    }
                },

                selectEpisode(episodeNumber) {
                    this.selectedEpisode = episodeNumber;
                    this.updateVideoUrl();
                },

                changeSource(sourceId) {
                    this.selectedSource = sourceId;
                    // Auto-close the sources panel after selection
                    this.showSources = false;
                    this.updateVideoUrl();
                },

                updateVideoUrl() {
                    const source = this.availableSources.find(s => s.id === this.selectedSource);
                    if (!source) return;

                    const params = this.isShow
                        ? { id: this.contentId, season: this.selectedSeason, episode: this.selectedEpisode }
                        : { id: this.contentId };

                    let url = this.isShow ? source.urls.tv : source.urls.movie;

                    Object.entries(params).forEach(([key, value]) => {
                        url = url.replace(`{${key}}`, value);
                    });

                    this.currentVideoUrl = url;

                    // Reset playback tracking for new video
                    this.hasConfirmedPlayback = false;
                    this.stopPlaybackTracking();

                    // Setup tracking for new video
                    this.setupPlaybackTracking();
                },

                // Playback tracking functions
                startPlaybackTracking() {
                    if (this.hasConfirmedPlayback) return;

                    this.playbackStarted = true;

                    // Set timer for minimum watch time
                    this.playbackTimer = setTimeout(() => {
                        this.confirmPlayback();
                    }, this.minWatchTime);

                    console.log('Started playback tracking for:', this.content?.title || this.content?.name);
                },

                stopPlaybackTracking() {
                    if (this.playbackTimer) {
                        clearTimeout(this.playbackTimer);
                        this.playbackTimer = null;
                    }
                    this.playbackStarted = false;
                },

                confirmPlayback() {
                    if (this.hasConfirmedPlayback) return;

                    this.hasConfirmedPlayback = true;
                    this.stopPlaybackTracking();

                    // Send data to index.html
                    const continueWatchingData = {
                        id: this.contentId,
                        title: this.content.title || this.content.name,
                        media_type: this.contentType,
                        poster_path: this.content.poster_path,
                        release_date: this.content.release_date || this.content.first_air_date,
                        vote_average: this.content.vote_average,
                        overview: this.content.overview
                    };

                    localStorage.setItem('streamSearch_continueWatching_update', JSON.stringify(continueWatchingData));

                    console.log('Playback confirmed, added to Continue Watching:', continueWatchingData.title);
                },

                setupPlaybackTracking() {
                    // Wait for iframe to load
                    setTimeout(() => {
                        const iframe = document.querySelector('.player-container iframe');
                        if (iframe) {
                            iframe.addEventListener('load', () => {
                                console.log('Video iframe loaded, starting playback tracking');
                                // Start tracking when iframe loads (indicates video is ready)
                                this.startPlaybackTracking();
                            });

                            // Also start tracking if iframe already has a src
                            if (iframe.src && iframe.src !== 'about:blank') {
                                this.startPlaybackTracking();
                            }
                        }
                    }, 1000);
                }
            }
        }
    </script>
</body>

</html>